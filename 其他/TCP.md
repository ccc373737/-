1.TCP简介

TCP(Transmission Control Protocol 传输控制协议)是一种面向连接(连接导向)的、可靠的、 基于IP的传输层协议。
TCP会将用户数据打包构成报文段，它发送数据时启动一个定时器，另一端收到数据进行确认，对失序的数据重新排序，丢弃重复的数据。TCP提供一种面向连接的可靠的字节流服务。

TCP的可靠性：
- 应用数据被分成TCP最合适的发送数据块
- 当TCP发送一个段之后，启动一个定时器，等待目的点确认收到报文，如果不能及时收到一个确认，将重发这个报文。
- 当TCP收到连接端发来的数据，就会推迟几分之一秒发送一个确认。
- TCP将保持它首部和数据的检验和，这是一个端对端的检验和，目的在于检测数据在传输过程中是否发生变化。（有错误，就不确认，发送端就会重发）
- TCP是以IP报文来传送，IP数据是无序的，TCP收到所有数据后进行排序，再交给应用层
- IP数据报会重复，所以TCP会去重
- TCP能提供流量控制，TCP连接的每一个地方都有固定的缓冲空间。TCP的接收端只允许另一端发送缓存区能接纳的数据。
- TCP对字节流不做任何解释，对字节流的解释由TCP连接的双方应用层解释。

2.TCP和UDP

- TCP面向连接，UDP无连接
- TCP慢，UDP快
- TCP可靠，UDP不可靠
- TCP数据量少，UDP数据量多
- TCP用于一般场景，对数据可靠性都有要求，UDP用于直播，视频这种传输大量数据，但可以允许丢失的场景

3.TCP三次握手

![](./images/tcp1.jpg)

- 建立连接时，客户端发送syn包，进入SYN-SENT阶段
- 服务端收到syn包，发送确认包ack=x+1，同时也发送自己的syn包，syn=y，进入SYN_RECV状态
- 客户端收到syn+ack包，同时也发送确认包ack=y+1
- 双方建立连接，开始传输数据

三次握手的本质在于信道不可靠的情况下，通信双方需要就传输达成一致的问题的解答。

那么为什么不是两次握手？因为两次握手，只有服务端对客户端进行了确认，只证明了客户端发，服务端收的能力。
而双方都证明有收发的能力，其实需要四次握手。
- A -send-> B：证明A可以发消息
- B -reveive-> A：证明B可以收消息
- B -send-> A：证明B可以发消息
- A -reveive-> B：证明A可以收消息

这其中第三步和第四步可以合在一起，就形成了三次握手。

那么三次握手是否可靠？其实也不可靠，因为任何时候网络都不可靠，但是三次握手是证明双方收发能力的最低值，在此之上，再增加几次握手也无法提高可靠性。

4.四次挥手

![](./images/tcp2.jpg)

为什么挥手是四次，发送和确认不能放在同一步。

因为关闭连接时，client发送FIN，此时server可能还有数据要发送，所以只能回一个ack确认，
然后在确认没有数据发送之后，再发送FIN，所以一共需要四次挥手。
